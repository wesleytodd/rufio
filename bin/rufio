#!/usr/bin/env node

var commander = require('commander'),
	exec = require('child_process').exec;

// CLI options
commander
	.option('-V, --version', 'output the version number')
	.option('-v, --verbose', 'Verbose logging')
	.option('-s, --silent', 'Silent output')
	.option('-d, --dev', 'Sets RUFIO_ENVIRONMENT to dev')
	.option('-e, --environment [environment]', 'Sets RUFIO_ENVIRONMENT to the supplied value')
	.usage('COMMAND [options]')
;

// Help command
commander
	.command('help')
	.description('Display this usage information.')
	.action(commander.help)
;

// Version, custom to prevent loading before env vars are set
commander.on('version', function() {
	console.log(require('..').version);
	process.exit(0);
});

// Build command
commander
	.command('build [ver]')
	.description('Builds the site. Specify an optional version.')
	.action(function(ver){

		// Set the build version if given
		if (ver) {
			process.env.RUFIO_BUILD_VERSION = ver;
		}

		// Load rufio
		var rufio = require('..');

		// Start Rufio
		rufio.init(function(err) {
			if (err) {
				console.error(err);
				process.exit(err);
			}

			// Load
			rufio.load.all(function(err, d) {
				if (err) {
					console.error(err);
					process.exit(err);
				}

				// Write
				rufio.write.all(d, function(e) {
					console.log('Site build complete to version: ' + rufio.config.get('BUILD_VERSION'));
				});
			});
		});

	});

// Change Active Version
commander
	.command('chver <ver>')
	.description('Changes the active version.')
	.action(function(ver) {

		// Load rufio
		var rufio = require('..');

		// Start Rufio
		rufio.init(function() {
			// Link the version to active
			exec('ln -sfn ./' + ver + ' ./active', {
				cwd: rufio.config.get('BUILD_ROOT')
			}, function(err, stdout, stderr) {
				if (err) return console.error(err);
				console.log('Active build changed to ' + ver);
			});
		});
	});

// Start Nginx Server
commander
	.command('serve <host> <port>')
	.description('Runs Nginx inside a Docker container.')
	.action(function(host, port) {

		// Load rufio
		var rufio = require('..');

		// Start Rufio
		rufio.init(function() {
			exec([
				'docker run -d',
				'-p ' + port + ':80',
				'-v ' + rufio.config.get('RUFIO_ROOT') + '/docker/config/nginx:/etc/nginx/sites-enabled',
				'-v ' + rufio.config.get('SITE_ROOT') + '/log/nginx:/var/log/nginx',
				'-v ' + rufio.config.get('BUILD_ROOT') + ':/usr/local/rufio/' + host
			].join(' '), function(err) {
				if (err) return console.error(err);
				console.log('Nginx started at ' + hostname + ':' + port);
			});
		});
	});

// Silent?
commander.on('silent', function() {
	process.env.RUFIO_SILENT = true;
});

// Verbose loggins?
commander.on('verbose', function() {
	process.env.RUFIO_VERBOSE_LOGGING = true;
});

// Environment?
commander.on('evironment', function(args) {
	process.env.RUFIO_ENVIRONMENT = args.environment;
});

// Dev Environment?
commander.on('dev', function(args) {
	process.env.RUFIO_ENVIRONMENT = 'dev';
});

// Parse the args
commander.parse(process.argv);

// If no other command was given show help
if (!commander.args.length) {
	return commander.help();
}
